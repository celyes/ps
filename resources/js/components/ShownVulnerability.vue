<template>
    <div class="row justify-content-center">
        <div class="col">
            <div class="card p-4">
                <div class="card-title">
                    <div class="row">
                        <div class="col">
                            <h1 class="fw-bold text-primary" >{{ vulnerability.title }}</h1>
                        </div>
                        <div class="col">
                            <div class="d-flex justify-content-end">
                                <a :href="`/vulnerabilities/${props.vid}/edit/`" class="btn btn-success btn-md me-2">Edit</a>
                                <button class="btn btn-danger btn-md me-2" @click="deleteVulnerability">Delete</button>
                            </div>
                        </div>
                    </div>
                    
                </div>
                <div class="card-body px-0">
                    <div class="row">
                        <div class="col-12">
                            CVSS Score:
                            <small class="text-secondary">{{ vulnerability.score }} </small>
                            (<small class="text-secondary" v-if="vulnerability.score <= 3.9">Low</small>
                            <small class="text-info" v-else-if="vulnerability.score <= 6.9">Medium</small>
                            <small class="text-warning" v-else-if="vulnerability.score <= 8.9">High</small>
                            <small  class="text-danger" v-else> Critical</small>)
                        </div>
                        <div class="col-12">
                            Aliases:
                            <small class="text-danger" v-for="(alias, k) in vulnerability.aliases" :key="k">{{alias.code}}</small>
                        </div>

                        <div class="col-12">
                            Published:
                            <small class="text-danger">{{ vulnerability.published }}</small>
                        </div>
                        <div class="col-12">
                            Last modified:
                            <small class="text-danger">{{ vulnerability.modified }}</small>
                        </div>

                        <div class="col-12">
                            <hr>
                            <div class="fw-bold mb-2">Affects:</div>
                            <table class="table table-bordered w-50 w-sm-100 text-center">
                            <thead>
                                <tr>
                                    <th scope="col">Package</th>
                                    <th scope="col">Ecosystem</th>
                                    <th scope="col">Introduced</th>
                                    <th scope="col">Fixed</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(affection, k) in vulnerability.affections" :key="k">
                                    <td>{{ affection.package }}</td>
                                    <td>{{ affection.ecosystem }}</td>
                                    <td>{{ affection.introduced }}</td>
                                    <td>{{ affection.fixed }}</td>
                                </tr>
                                </tbody>
                            </table>
                        
                        </div>

                        <div class="col-12">
                            <hr>
                            <p class="fs-6 fw-bold text-bold">Summary</p>
                            <p class="fs-6 fw-light text-secondary">{{ vulnerability.summary }}</p>
                        </div>

                        <div class="col-12">
                            <p class="fs-5 fw-light">{{ vulnerability.description }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script setup>
import axios from 'axios';
import { defineProps, ref, onMounted, computed } from 'vue';

let vulnerability = ref({})
let severity = ref('low');
let props = defineProps(['vid'])

onMounted(() => {
    fetchVulnerability()
})

const fetchVulnerability = () => {
    axios.get(`http://localhost:8000/api/vulnerability/${props.vid}`)
    .then(res => { vulnerability.value = res.data.data })
    .catch(e => { console.error(e) })
}

const deleteVulnerability = () => {
    if(confirm("Are you sure you wanna proceed? this can't be undone !")) {
         axios.delete(`http://localhost:8000/api/vulnerability/${props.vid}`)
        .then(res => { 
            if(res.status === 200) {
                window.location = '/'
            }
         })
        .catch(e => { console.error(e) })
    }
}
</script>
