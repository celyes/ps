<template>
    <div>
        <h1 class="text-center my-5">{{ props.vid !== undefined ? 'Edit': 'Add' }} {{ vulnerability.title }} vulnerability </h1>
        <div v-if="hasBeenEdited" class="alert alert-success" role="alert">
            Vulnerability edited successfully! <a :href="`/vulnerabilities/${props.vid}`">Visit</a>
        </div>
        <div v-if="hasBeenAdded.status" class="alert alert-success" role="alert">
            Vulnerability created successfully! <a :href="`/vulnerabilities/${hasBeenAdded.createdId}`">Visit</a>
        </div>

        <form @submit.prevent="updateOrCreate">
            <div class="row">
                <div class="col mb-3">
                    <label for="nameInput" class="form-label text-secondary">Name</label>
                    <input :class="{ 'is-invalid': validation?.errors?.title }" v-model="vulnerability.title" type="text" class="form-control"  placeholder="e.g: Broken Access Control">
                    <div v-if="validation?.errors" >
                        <p class="text-danger m-0" v-for="(e, k) in validation.errors.title" :key="k"><small>{{ e }}</small></p>
                    </div>
                </div>

                <div class="col mb-3">
                    <label class="form-label text-secondary">Alias</label>
                    <input :class="{ 'is-invalid': validation?.errors?.['aliases.0.code']?.length > 0 }"  v-model="vulnerability.aliases[0].code" type="text" class="form-control" placeholder="CVE-20XX-12345">
                    <div v-if="validation?.errors">
                        <p class="text-danger m-0" v-for="(e, k) in validation.errors['aliases.0.code']" :key="k"><small>{{ e }}</small></p>
                    </div>
                </div>

                <div class="col mb-3">
                    <label class="form-label text-secondary">CVSS Score</label>
                    <input :class="{ 'is-invalid': validation?.errors?.score }" v-model="vulnerability.score" type="number" step="0.1" min="0" max="10" class="form-control" placeholder="e.g: 5.0">
                    <div v-if="validation?.errors" >
                        <p class="text-danger m-0" v-for="(e, k) in validation.errors.score" :key="k"><small>{{ e }}</small></p>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="fw-bold">Affects</div>
                </div>
                <div class="col">
                    <div class="mb-3">
                        <label class="form-label text-secondary"><small>name</small></label>
                        <input :class="{ 'is-invalid': validation?.errors?.['affections.0.package'] }" v-model="vulnerability.affections[0].package" class="form-control" placeholder="e.g: WordPress">
                        <div v-if="validation?.errors">
                            <p class="text-danger m-0" v-for="(e, k) in validation.errors['affections.0.package']" :key="k"><small>{{ e }}</small></p>
                        </div>
                    </div>
                </div>

                <div class="col">
                    <div class="mb-3">
                        <label class="form-label"><small>ecosystem</small></label>
                        <input :class="{ 'is-invalid': validation?.errors?.['affections.0.ecosystem'] }" v-model="vulnerability.affections[0].ecosystem" class="form-control" placeholder="e.g: PHP">

                        <div v-if="validation?.errors">
                            <p class="text-danger m-0" v-for="(e, k) in validation.errors['affections.0.ecosystem']" :key="k"><small>{{ e }}</small></p>
                        </div>
                    </div>
                </div>

                <div class="col">
                    <div class="mb-3">
                        <label class="form-label text-secondary"><small>introduced at</small></label>
                        <input :class="{ 'is-invalid': validation?.errors?.['affections.0.introduced'] }" v-model="vulnerability.affections[0].introduced" class="form-control" id="introducedAtInput" placeholder="e.g: v1.2.3">

                        <div v-if="validation?.errors">
                            <p class="text-danger m-0" v-for="(e, k) in validation.errors['affections.0.introduced']" :key="k"><small>{{ e }}</small></p>
                        </div>
                    </div>
                </div>

                <div class="col">
                    <div class="mb-3">
                        <label class="form-label text-secondary"><small>fixed at</small></label>
                        <input :class="{ 'is-invalid': validation?.errors?.['affections.0.fixed'] }" v-model="vulnerability.affections[0].fixed" class="form-control" placeholder="e.g: v4.5.6">
                        <div v-if="validation?.errors">
                            <p class="text-danger m-0" v-for="(e, k) in validation.errors['affections.0.fixed']" :key="k"><small>{{ e }}</small></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="mb-3">
                        <label class="form-label">Summary</label>
                        <textarea :class="{'is-invalid': validation?.errors?.summary}" v-model="vulnerability.summary" class="form-control" s rows="3"></textarea>
                        <div v-if="validation?.errors">
                            <p class="text-danger m-0" v-for="(e, k) in validation?.errors.summary" :key="k"><small>{{ e }}</small></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea :class="{'is-invalid': validation?.errors?.description}" v-model="vulnerability.description" class="form-control" rows="10"></textarea>
                        <div v-if="validation?.errors">
                            <p class="text-danger m-0" v-for="(e, k) in validation?.errors.description" :key="k"><small>{{ e }}</small></p>
                        </div>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-lg btn-primary w-100">{{ isEdit ? 'Update' : 'Submit' }} Vulnerability</button>
        </form>
    </div>
</template>


<script setup>

import axios from 'axios';
import { ref, defineProps, onMounted } from 'vue'

const props = defineProps(['vid']);
const isEdit = ref(false)
const newReference = ref({type: 'WEB', url: ''})
const vulnerability = ref({
    title: "",
    aliases: [
        { code: "" }
    ],
    score: "",
    affections: [
        {
            package: "",
            ecosystem: "",
            introduced: "",
            fixed: "",
        }
    ]
})
const validation = ref({})
const hasBeenEdited = ref(false)
const hasBeenAdded = ref({})

const updateOrCreate = () => {
    isEdit.value ? update() : create()
}

const update = () => {
    axios.patch(`http://localhost:8000/api/vulnerability/${props.vid}`, vulnerability.value)
    .then(res => { vulnerability.value = res.data.data })
    .then(() => { hasBeenEdited.value = true })
    .catch(e => { validation.value = e.response.data })
}

const create = () => {
    axios.post(`http://localhost:8000/api/vulnerability`, vulnerability.value)
    .then(res => { 
        vulnerability.value = res.data.data
        hasBeenAdded.value.status =  true
        hasBeenAdded.value.createdId = res.data.data.id
    })
    .then(() => { errors.value = {} })
    .catch(e => { validation.value = e.response?.data })
}

const loadVulnerability = () => {
    axios.get('http://localhost:8000/api/vulnerability/'+props.vid)
    .then(res => { vulnerability.value = res.data.data })
    .catch(e => { validation.value = e.response.data })
}
onMounted(() => {
    if(props.vid  !== undefined) { 
        isEdit.value = true 
        loadVulnerability()    
    }
    
})
</script>